fixture: Robby
description: Creates a user and logs them in
type: RPC

use-fixtures:
  - RootUser

# Variables to be made available to tests.
# Variables are stored in the session context associated with the fixture.
export: [ "name", "email", "id", "edit-token" ]

variables:
  name: "Robby"
  email: "robby@example"
  password: p/uniq: "pw-"

setup:
  # Get a createaccount token for the root user
  - use-session: RootUser # use the root user's session, not the session created above
    request:
      path: api.php
      parameters:
        action: query
        meta: tokens
        type: createaccount|rights
        format: json
    response:
      body:
        query:
          tokens:
            # grab values and store them in variables in
            # the local copy of the RootUser's session context
            createaccount: p/grab: creation-token
            userrights: p/grab: rights-token

  # Create a new user account
  - use-session: RootUser # use the root user's session, not the session created above
    request:
      path: api.php
      parameters:
        action: createaccount
        format: json
      form-data:
        username: p/var: name # from the fixture's local context
        password: p/var: password
        retype: p/var: password
        email: p/var: email
        creationtoken: p/var: creation-token # from the RootUser's context, see above
    response:
      body:
        creataccount:
          status: PASS

  # Add to bot group
  - use-session: RootUser # use the root user's session, not the session created above
    request:
      path: api.php
      parameters:
        action: userrights
        format: json
      form-data:
        user: p/var: name
        token: p/var: rights-token # from the RootUser session context
        add: bot
    response:
      body:
        userrights:
          added: [ 'bot' ]

  # Get a login token (using the new session created above)
  - request:
      path: api.php
      parameters:
        action: query
        meta: tokens
        type: login
        format: json
    response:
      body:
        query:
          tokens:
            login: p/grab: token # from the RootUser session context

  # Log in (using the new session created above)
  - request:
      method: post
      path: api.php
      parameters:
        action: login
        format: json
      form-data:
        lgname: p/var: name
        lgpassword: p/var: password
        lgtoken: p/var: token
    response:
      body:
        login:
          result: "Success"
          lguserid: p/grab: id
          lgusername: p/grab: name

  # Get an edit token (using the user's session)
  - request:
      path: api.php
      parameters:
        action: query
        meta: tokens
        type: csrf
        format: json
    response:
      body:
        query:
          tokens:
            csrf: p/grab: edit-token

